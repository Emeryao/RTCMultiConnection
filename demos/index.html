<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="utf-8">
    <title>订单播放</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <link rel="shortcut icon" href="/demos/logo.png">
    <link rel="stylesheet" href="/demos/stylesheet.css">
    <script src="/demos/menu.js"></script>
    <script src="/demos/js/jquery.min.js"></script>
    <style>
        .media-controls,
        .media-box>h2 {
            display: none !important;
        }

        .media-container {
            width: 81vw !important;
        }
    </style>
</head>

<body>
    <header style="display: none;">
        <a class="logo" href="/"><img src="/demos/logo.png" alt="RTCMultiConnection"></a>
        <a href="/" class="menu-explorer">Menu<img src="/demos/menu-icon.png" alt="Menu"></a>
        <nav>
            <li>
                <a href="/">Home</a>
            </li>
            <li>
                <a href="/demos/">Demos</a>
            </li>
            <li>
                <a href="https://www.rtcmulticonnection.org/docs/getting-started/">Getting Started</a>
            </li>
            <li>
                <a href="https://www.rtcmulticonnection.org/FAQ/">FAQ</a>
            </li>
            <li>
                <a href="https://www.youtube.com/playlist?list=PLPRQUXAnRydKdyun-vjKPMrySoow2N4tl">YouTube</a>
            </li>
            <li>
                <a href="https://github.com/muaz-khan/RTCMultiConnection/wiki">Wiki</a>
            </li>
            <li>
                <a href="https://github.com/muaz-khan/RTCMultiConnection">Github</a>
            </li>
        </nav>
    </header>

    <h1 style="display: none;">
        Video OneWay Broadcasting using RTCMultiConnection
        <p class="no-mobile">
            Multi-user (one-to-many) video broadcasting using star topology.
        </p>
    </h1>

    <!-- <header style="text-align: center;background-color: lightblue;padding: 1rem;">订单播放</header> -->
    <section class="make-center">
        摄像头：
        <select id="camera-select">
            <option value="">请选择摄像头</option>
        </select>
        <br>
        <br>
        订单号：
        <input id="orderNo" type="text" placeholder="请输入订单号">
        <br>
        <br>
        <input style="display: none;" type="text" id="room-id" autocorrect="off" autocapitalize="off" size="20">
        <button id="open-room">开始</button>
        <button style="display: none;" id="join-room">加入</button>
        <button id="stop-stream">停止</button>
        <button id="up-post">上报</button>
        <button style="display: none;" id="open-or-join-room">Auto Open Or Join Room</button>

        <div id="videos-container" style="margin: 20px 0;"></div>

        <div id="room-urls" style="text-align: center;display: none;background: #F1EDED;margin: 15px -10px;border: 1px solid rgb(189, 189, 189);border-left: 0;border-right: 0;"></div>
    </section>

    <script src="/dist/RTCMultiConnection.js"></script>
    <script src="/node_modules/webrtc-adapter/out/adapter.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <!-- custom layout for HTML5 audio/video elements -->
    <link rel="stylesheet" href="/dev/getHTMLMediaElement.css">
    <script src="/dev/getHTMLMediaElement.js"></script>

    <script src="node_modules/recordrtc/RecordRTC.js"></script>

    <script>
        let roomId = '';
        var cameraDeviceId = '';
        // ......................................................
        // .......................UI Code........................
        // ......................................................
        document.getElementById('open-room').onclick = function () {
            // disableInputButtons();
            if (!cameraDeviceId) {
                alert('请选择摄像头');
                return;
            }
            if (!orderNo.value) {
                alert('请输入订单号');
                return;
            }
            connection.open(roomId, function () {
                showRoomURL(connection.sessionid);
                $.post('/api', JSON.stringify([{
                    roomId,
                    orderNo: orderNo.value
                }]));
                // localStorage.setItem('current', JSON.stringify([{
                //     roomId,
                //     orderNo: orderNo.value
                // }]));
            });
        };

        document.getElementById('join-room').onclick = function () {
            disableInputButtons();

            connection.sdpConstraints.mandatory = {
                OfferToReceiveAudio: true,
                OfferToReceiveVideo: true
            };
            connection.join(roomId);
        };

        document.getElementById('open-or-join-room').onclick = function () {
            disableInputButtons();
            connection.openOrJoin(roomId, function (isRoomExist, roomid) {
                if (isRoomExist === false && connection.isInitiator === true) {
                    // if room doesn't exist, it means that current user will create the room
                    showRoomURL(roomid);
                }

                if (isRoomExist) {
                    connection.sdpConstraints.mandatory = {
                        OfferToReceiveAudio: true,
                        OfferToReceiveVideo: true
                    };
                }
            });
        };

        document.getElementById('camera-select').onchange = () => {
            cameraDeviceId = document.getElementById('camera-select').value;
            connection.mediaConstraints = {
                audio: true,
                video: {
                    mandatory: {},
                    optional: [{
                        sourceId: cameraDeviceId,
                    }]
                }
            };
            // disconnect with all users
            connection.getAllParticipants().forEach(function (pid) {
                connection.disconnectWith(pid);
            });

            // stop all local cameras
            connection.attachStreams.forEach(function (localStream) {
                localStream.stop();
            });

            // close socket.io connection
            connection.closeSocket();
            // connection.open(roomId, function () {
            //     showRoomURL(connection.sessionid);
            // });
        }

        document.getElementById('stop-stream').onclick = () => {
            // disconnect with all users
            connection.getAllParticipants().forEach(function (pid) {
                connection.disconnectWith(pid);
            });

            // stop all local cameras
            connection.attachStreams.forEach(function (localStream) {
                localStream.stop();
            });

            // close socket.io connection
            connection.closeSocket();
            $.post('/api', JSON.stringify([]));
        }



        // document.getElementById('up-post').onclick = async () => {
        //     let stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        //     let recorder = new RecordRTCPromisesHandler(stream, {
        //         type: 'video',
        //         mimeType: 'video/webm\;codecs=h264',
        //         fileExtension: 'mp4',
        //     });
        //     recorder.startRecording();

        //     const sleep = m => new Promise(r => setTimeout(r, m));
        //     await sleep(15000);

        //     await recorder.stopRecording();
        //     let blob = await recorder.getBlob();
        //     invokeSaveAsDialog(blob);
        // }

        var recordingPlayer;
        var type = 'video';
        var recorderType;

        btnStartRecording = document.getElementById('up-post');

        btnStartRecording.onclick = function (event) {
            if (!cameraDeviceId) {
                alert('请选择摄像头');
                return;
            }
            var video = document.createElement('video');
            video.controls = false;
            var mediaElement = getHTMLMediaElement(video, {
                title: 'Recording status: inactive',
                buttons: ['full-screen' /*, 'take-snapshot'*/],
                showOnMouseEnter: false,
                width: 360,
                onTakeSnapshot: function () {
                    var canvas = document.createElement('canvas');
                    canvas.width = mediaElement.clientWidth;
                    canvas.height = mediaElement.clientHeight;

                    var context = canvas.getContext('2d');
                    context.drawImage(recordingPlayer, 0, 0, canvas.width, canvas.height);

                    window.open(canvas.toDataURL('image/png'));
                }
            });
            document.getElementById('videos-container').appendChild(mediaElement);

            recordingPlayer = mediaElement.media;


            var button = btnStartRecording;

            if (button.innerHTML === 'Stop Recording') {
                // btnPauseRecording.style.display = 'none';
                button.disabled = true;
                button.disableStateWaiting = true;
                setTimeout(function () {
                    button.disabled = false;
                    button.disableStateWaiting = false;
                }, 2000);

                // button.innerHTML = 'Start Recording';

                function stopStream() {
                    if (button.stream && button.stream.stop) {
                        button.stream.stop();
                        button.stream = null;
                    }

                    if (button.stream instanceof Array) {
                        button.stream.forEach(function (stream) {
                            stream.stop();
                        });
                        button.stream = null;
                    }

                    videoBitsPerSecond = null;
                    var html = 'Recording status: stopped';
                    html += '<br>Size: ' + bytesToSize(button.recordRTC.getBlob().size);
                    // recordingPlayer.parentNode.parentNode.querySelector('h2').innerHTML = html;
                }

                if (button.recordRTC) {
                    if (button.recordRTC.length) {
                        button.recordRTC[0].stopRecording(function (url) {
                            if (!button.recordRTC[1]) {
                                button.recordingEndedCallback(url);
                                stopStream();

                                // saveToDiskOrOpenNewTab(button.recordRTC[0]);
                                return;
                            }

                            button.recordRTC[1].stopRecording(function (url) {
                                button.recordingEndedCallback(url);
                                stopStream();
                            });
                        });
                    } else {
                        button.recordRTC.stopRecording(function (url) {
                            if (button.blobs && button.blobs.length) {
                                var blob = new File(button.blobs, getFileName(fileExtension), {
                                    type: mimeType
                                });

                                button.recordRTC.getBlob = function () {
                                    return blob;
                                };

                                url = URL.createObjectURL(blob);
                            }

                            // if (chkFixSeeking.checked === true) {
                            //     // to fix video seeking issues
                            //     getSeekableBlob(button.recordRTC.getBlob(), function (seekableBlob) {
                            //         button.recordRTC.getBlob = function () {
                            //             return seekableBlob;
                            //         };

                            //         url = URL.createObjectURL(seekableBlob);

                            //         button.recordingEndedCallback(url);
                            //         saveToDiskOrOpenNewTab(button.recordRTC);
                            //         stopStream();
                            //     })
                            //     return;
                            // }

                            button.recordingEndedCallback(url);
                            // saveToDiskOrOpenNewTab(button.recordRTC);
                            stopStream();
                        });
                    }
                }

                return;
            }

            if (!event) return;

            button.disabled = true;

            var commonConfig = {
                onMediaCaptured: function (stream) {
                    button.stream = stream;
                    if (button.mediaCapturedCallback) {
                        button.mediaCapturedCallback();
                    }

                    // button.innerHTML = 'Stop Recording';
                    // button.disabled = false;

                    // chkFixSeeking.parentNode.style.display = 'none';
                },
                onMediaStopped: function () {
                    button.innerHTML = 'Start Recording';

                    if (!button.disableStateWaiting) {
                        button.disabled = false;
                    }

                    // chkFixSeeking.parentNode.style.display = 'inline-block';
                },
                onMediaCapturingFailed: function (error) {
                    console.error('onMediaCapturingFailed:', error);

                    if (error.toString().indexOf('no audio or video tracks available') !== -1) {
                        alert('RecordRTC failed to start because there are no audio or video tracks available.');
                    }

                    if (error.name === 'PermissionDeniedError' && DetectRTC.browser.name === 'Firefox') {
                        alert('Firefox requires version >= 52. Firefox also requires HTTPs.');
                    }

                    commonConfig.onMediaStopped();
                }
            };

            mimeType = 'video/webm\;codecs=h264';
            // mimeType = 'video/mpeg';
            fileExtension = 'mp4';

            // if (mediaContainerFormat.value === 'h264') {
            //     mimeType = 'video/webm\;codecs=h264';
            //     fileExtension = 'mp4';

            //     // video/mp4;codecs=avc1
            //     if (isMimeTypeSupported('video/mpeg')) {
            //         mimeType = 'video/mpeg';
            //     }
            // }

            // if (mediaContainerFormat.value === 'mkv' && isMimeTypeSupported('video/x-matroska;codecs=avc1')) {
            //     mimeType = 'video/x-matroska;codecs=avc1';
            //     fileExtension = 'mkv';
            // }

            // if (mediaContainerFormat.value === 'vp8' && isMimeTypeSupported('video/webm\;codecs=vp8')) {
            //     mimeType = 'video/webm\;codecs=vp8';
            //     fileExtension = 'webm';
            //     recorderType = null;
            //     type = 'video';
            // }

            // if (mediaContainerFormat.value === 'vp9' && isMimeTypeSupported('video/webm\;codecs=vp9')) {
            //     mimeType = 'video/webm\;codecs=vp9';
            //     fileExtension = 'webm';
            //     recorderType = null;
            //     type = 'video';
            // }

            // if (mediaContainerFormat.value === 'pcm') {
            //     mimeType = 'audio/wav';
            //     fileExtension = 'wav';
            //     recorderType = StereoAudioRecorder;
            //     type = 'audio';
            // }

            // if (mediaContainerFormat.value === 'opus' || mediaContainerFormat.value === 'ogg') {
            //     if (isMimeTypeSupported('audio/webm')) {
            //         mimeType = 'audio/webm';
            //         fileExtension = 'webm'; // webm
            //     }

            //     if (isMimeTypeSupported('audio/ogg')) {
            //         mimeType = 'audio/ogg; codecs=opus';
            //         fileExtension = 'ogg'; // ogg
            //     }

            //     recorderType = null;
            //     type = 'audio';
            // }

            // if (mediaContainerFormat.value === 'whammy') {
            //     mimeType = 'video/webm';
            //     fileExtension = 'webm';
            //     recorderType = WhammyRecorder;
            //     type = 'video';
            // }

            // if (mediaContainerFormat.value === 'WebAssembly') {
            //     mimeType = 'video/webm';
            //     fileExtension = 'webm';
            //     recorderType = WebAssemblyRecorder;
            //     type = 'video';
            // }

            // if (mediaContainerFormat.value === 'gif') {
            //     mimeType = 'image/gif';
            //     fileExtension = 'gif';
            //     recorderType = GifRecorder;
            //     type = 'gif';
            // }

            // if (mediaContainerFormat.value === 'default') {
            //     mimeType = 'video/webm';
            //     fileExtension = 'webm';
            //     recorderType = null;
            //     type = 'video';
            // }

            captureAudioPlusVideo(commonConfig);

            button.mediaCapturedCallback = function () {
                if (typeof MediaRecorder === 'undefined') { // opera or chrome etc.
                    button.recordRTC = [];

                    if (!params.bufferSize) {
                        // it fixes audio issues whilst recording 720p
                        params.bufferSize = 16384;
                    }

                    var options = {
                        type: 'audio', // hard-code to set "audio"
                        leftChannel: params.leftChannel || false,
                        disableLogs: params.disableLogs || false,
                        video: recordingPlayer
                    };

                    if (params.sampleRate) {
                        options.sampleRate = parseInt(params.sampleRate);
                    }

                    if (params.bufferSize) {
                        options.bufferSize = parseInt(params.bufferSize);
                    }

                    if (params.frameInterval) {
                        options.frameInterval = parseInt(params.frameInterval);
                    }

                    if (recorderType) {
                        options.recorderType = recorderType;
                    }

                    if (videoBitsPerSecond) {
                        options.videoBitsPerSecond = videoBitsPerSecond;
                    }

                    options.ignoreMutedMedia = false;
                    var audioRecorder = RecordRTC(button.stream, options);

                    options.type = type;
                    var videoRecorder = RecordRTC(button.stream, options);

                    // to sync audio/video playbacks in browser!
                    videoRecorder.initRecorder(function () {
                        audioRecorder.initRecorder(function () {
                            audioRecorder.startRecording();
                            videoRecorder.startRecording();
                            // btnPauseRecording.style.display = '';
                        });
                    });

                    button.recordRTC.push(audioRecorder, videoRecorder);

                    button.recordingEndedCallback = function () {
                        var audio = new Audio();
                        audio.src = audioRecorder.toURL();
                        audio.controls = true;
                        audio.autoplay = true;

                        recordingPlayer.parentNode.appendChild(document.createElement('hr'));
                        recordingPlayer.parentNode.appendChild(audio);

                        if (audio.paused) audio.play();
                    };
                    return;
                }

                var options = {
                    type: type,
                    mimeType: mimeType,
                    disableLogs: params.disableLogs || false,
                    getNativeBlob: false, // enable it for longer recordings
                    video: recordingPlayer
                };

                if (recorderType) {
                    options.recorderType = recorderType;

                    if (recorderType == WhammyRecorder || recorderType == GifRecorder || recorderType == WebAssemblyRecorder) {
                        options.canvas = options.video = {
                            width: defaultWidth || 320,
                            height: defaultHeight || 240
                        };
                    }
                }

                if (videoBitsPerSecond) {
                    options.videoBitsPerSecond = videoBitsPerSecond;
                }
                var timeSlice = false;
                if (timeSlice && typeof MediaRecorder !== 'undefined') {
                    options.timeSlice = timeSlice;
                    button.blobs = [];
                    options.ondataavailable = function (blob) {
                        button.blobs.push(blob);
                    };
                }

                options.ignoreMutedMedia = false;
                button.recordRTC = RecordRTC(button.stream, options);

                button.recordingEndedCallback = function (url) {
                    setVideoURL(url);
                };

                button.recordRTC.startRecording();
                // btnPauseRecording.style.display = '';
                // recordingPlayer.parentNode.parentNode.querySelector('h2').innerHTML = '<img src="https://www.webrtc-experiment.com/images/progress.gif">';
            };


            setTimeout(() => {
                var button = btnStartRecording;
                // btnPauseRecording.style.display = 'none';
                button.disabled = true;
                button.disableStateWaiting = true;
                setTimeout(function () {
                    button.disabled = false;
                    button.disableStateWaiting = false;
                }, 2000);

                button.innerHTML = 'Start Recording';

                function stopStream() {
                    if (button.stream && button.stream.stop) {
                        button.stream.stop();
                        button.stream = null;
                    }

                    if (button.stream instanceof Array) {
                        button.stream.forEach(function (stream) {
                            stream.stop();
                        });
                        button.stream = null;
                    }

                    videoBitsPerSecond = null;
                    var html = 'Recording status: stopped';
                    html += '<br>Size: ' + bytesToSize(button.recordRTC.getBlob().size);
                    // recordingPlayer.parentNode.parentNode.querySelector('h2').innerHTML = html;
                }

                if (button.recordRTC) {
                    if (button.recordRTC.length) {
                        button.recordRTC[0].stopRecording(function (url) {
                            if (!button.recordRTC[1]) {
                                button.recordingEndedCallback(url);
                                stopStream();

                                // saveToDiskOrOpenNewTab(button.recordRTC[0]);
                                return;
                            }

                            button.recordRTC[1].stopRecording(function (url) {
                                button.recordingEndedCallback(url);
                                stopStream();
                            });
                        });
                    } else {
                        button.recordRTC.stopRecording(function (url) {
                            if (button.blobs && button.blobs.length) {
                                var blob = new File(button.blobs, getFileName(fileExtension), {
                                    type: mimeType
                                });

                                button.recordRTC.getBlob = function () {
                                    return blob;
                                };

                                url = URL.createObjectURL(blob);
                            }

                            // if (chkFixSeeking.checked === true) {
                            //     // to fix video seeking issues
                            //     getSeekableBlob(button.recordRTC.getBlob(), function (seekableBlob) {
                            //         button.recordRTC.getBlob = function () {
                            //             return seekableBlob;
                            //         };

                            //         url = URL.createObjectURL(seekableBlob);

                            //         button.recordingEndedCallback(url);
                            //         saveToDiskOrOpenNewTab(button.recordRTC);
                            //         stopStream();
                            //     })
                            //     return;
                            // }

                            button.recordingEndedCallback(url);
                            // saveToDiskOrOpenNewTab(button.recordRTC);

                            stopStream();
                            if (!button.recordRTC) return alert('No recording found.');
                            var fileName = getFileName(fileExtension);
                            var file = new File([button.recordRTC.getBlob()], fileName, {
                                type: mimeType
                            });

                            invokeSaveAsDialog(file, file.name);
                        });
                    }
                }
                return;
            }, 11000);
        };

        function captureAudioPlusVideo(config) {
            captureUserMedia({
                video: true,
                audio: true
            }, function (audioVideoStream) {
                config.onMediaCaptured(audioVideoStream);

                if (audioVideoStream instanceof Array) {
                    audioVideoStream.forEach(function (stream) {
                        addStreamStopListener(stream, function () {
                            config.onMediaStopped();
                        });
                    });
                    return;
                }

                addStreamStopListener(audioVideoStream, function () {
                    config.onMediaStopped();
                });
            }, function (error) {
                config.onMediaCapturingFailed(error);
            });
        }

        function captureUserMedia(mediaConstraints, successCallback, errorCallback) {
            if (mediaConstraints.video == true) {
                mediaConstraints.video = {
                    deviceId: cameraDeviceId
                };
            }

            setVideoBitrates();

            mediaConstraints = getVideoResolutions(mediaConstraints);
            mediaConstraints = getFrameRates(mediaConstraints);

            var isBlackBerry = !!(/BB10|BlackBerry/i.test(navigator.userAgent || ''));
            if (isBlackBerry && !!(navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia)) {
                navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
                navigator.getUserMedia(mediaConstraints, successCallback, errorCallback);
                return;
            }

            navigator.mediaDevices.getUserMedia(mediaConstraints).then(function (stream) {
                successCallback(stream);

                setVideoURL(stream, true);
            }).catch(function (error) {
                if (error && (error.name === 'ConstraintNotSatisfiedError' || error.name === 'OverconstrainedError')) {
                    alert('Your camera or browser does NOT supports selected resolutions or frame-rates. \n\nPlease select "default" resolutions.');
                } else if (error && error.message) {
                    alert(error.message);
                } else {
                    alert('Unable to make getUserMedia request. Please check browser console logs.');
                }

                errorCallback(error);
            });
        }

        function setVideoBitrates() {
            // var select = document.querySelector('.media-bitrates');
            var value = 'default';

            if (value == 'default') {
                videoBitsPerSecond = null;
                return;
            }

            videoBitsPerSecond = parseInt(value);
        }

        function getFrameRates(mediaConstraints) {
            if (!mediaConstraints.video) {
                return mediaConstraints;
            }

            // var select = document.querySelector('.media-framerates');
            var value = 'default';

            if (value == 'default') {
                return mediaConstraints;
            }

            value = parseInt(value);

            if (DetectRTC.browser.name === 'Firefox') {
                mediaConstraints.video.frameRate = value;
                return mediaConstraints;
            }

            if (!mediaConstraints.video.mandatory) {
                mediaConstraints.video.mandatory = {};
                mediaConstraints.video.optional = [];
            }

            var isScreen = recordingMedia.value.toString().toLowerCase().indexOf('screen') != -1;
            if (isScreen) {
                mediaConstraints.video.mandatory.maxFrameRate = value;
            } else {
                mediaConstraints.video.mandatory.minFrameRate = value;
            }

            return mediaConstraints;
        }

        function getVideoResolutions(mediaConstraints) {
            if (!mediaConstraints.video) {
                return mediaConstraints;
            }

            // var select = document.querySelector('.media-resolutions');
            var value = 'default';

            if (value == 'default') {
                return mediaConstraints;
            }

            value = value.split('x');

            if (value.length != 2) {
                return mediaConstraints;
            }

            defaultWidth = parseInt(value[0]);
            defaultHeight = parseInt(value[1]);

            if (DetectRTC.browser.name === 'Firefox') {
                mediaConstraints.video.width = defaultWidth;
                mediaConstraints.video.height = defaultHeight;
                return mediaConstraints;
            }

            if (!mediaConstraints.video.mandatory) {
                mediaConstraints.video.mandatory = {};
                mediaConstraints.video.optional = [];
            }

            var isScreen = recordingMedia.value.toString().toLowerCase().indexOf('screen') != -1;

            if (isScreen) {
                mediaConstraints.video.mandatory.maxWidth = defaultWidth;
                mediaConstraints.video.mandatory.maxHeight = defaultHeight;
            } else {
                mediaConstraints.video.mandatory.minWidth = defaultWidth;
                mediaConstraints.video.mandatory.minHeight = defaultHeight;
            }

            return mediaConstraints;
        }

        function addStreamStopListener(stream, callback) {
            stream.addEventListener('ended', function () {
                callback();
                callback = function () { };
            }, false);
            stream.addEventListener('inactive', function () {
                callback();
                callback = function () { };
            }, false);
            stream.getTracks().forEach(function (track) {
                track.addEventListener('ended', function () {
                    callback();
                    callback = function () { };
                }, false);
                track.addEventListener('inactive', function () {
                    callback();
                    callback = function () { };
                }, false);
            });
        }

        function getURL(arg) {
            var url = arg;

            if (arg instanceof Blob || arg instanceof File) {
                url = URL.createObjectURL(arg);
            }

            if (arg instanceof RecordRTC || arg.getBlob) {
                url = URL.createObjectURL(arg.getBlob());
            }

            if (arg instanceof MediaStream || arg.getTracks) {
                // url = URL.createObjectURL(arg);
            }

            return url;
        }

        function setVideoURL(arg, forceNonImage) {
            var url = getURL(arg);

            var parentNode = recordingPlayer.parentNode;
            parentNode.removeChild(recordingPlayer);
            parentNode.innerHTML = '';

            var elem = 'video';
            if (type == 'gif' && !forceNonImage) {
                elem = 'img';
            }
            if (type == 'audio') {
                elem = 'audio';
            }

            recordingPlayer = document.createElement(elem);

            if (arg instanceof MediaStream) {
                recordingPlayer.muted = true;
            }

            recordingPlayer.addEventListener('loadedmetadata', function () {
                if (navigator.userAgent.toLowerCase().indexOf('android') == -1) return;

                // android
                setTimeout(function () {
                    if (typeof recordingPlayer.play === 'function') {
                        recordingPlayer.play();
                    }
                }, 2000);
            }, false);

            recordingPlayer.poster = '';

            if (arg instanceof MediaStream) {
                recordingPlayer.srcObject = arg;
            } else {
                recordingPlayer.src = url;
            }

            if (typeof recordingPlayer.play === 'function') {
                recordingPlayer.play();
            }

            recordingPlayer.addEventListener('ended', function () {
                url = getURL(arg);

                if (arg instanceof MediaStream) {
                    recordingPlayer.srcObject = arg;
                } else {
                    recordingPlayer.src = url;
                }
            });

            parentNode.appendChild(recordingPlayer);
        }

        function getRandomString() {
            if (window.crypto && window.crypto.getRandomValues && navigator.userAgent.indexOf('Safari') === -1) {
                var a = window.crypto.getRandomValues(new Uint32Array(3)),
                    token = '';
                for (var i = 0, l = a.length; i < l; i++) {
                    token += a[i].toString(36);
                }
                return token;
            } else {
                return (Math.random() * new Date().getTime()).toString(36).replace(/\./g, '');
            }
        }

        function getFileName(fileExtension) {
            var d = new Date();
            var year = d.getUTCFullYear();
            var month = d.getUTCMonth();
            var date = d.getUTCDate();
            return 'RecordRTC-' + year + month + date + '-' + getRandomString() + '.' + fileExtension;
        }

        // ......................................................
        // ..................RTCMultiConnection Code.............
        // ......................................................

        var connection = new RTCMultiConnection();

        // by default, socket.io server is assumed to be deployed on your own URL
        connection.socketURL = '/';

        // comment-out below line if you do not have your own socket.io server
        // connection.socketURL = 'https://rtcmulticonnection.herokuapp.com:443/';

        connection.socketMessageEvent = 'video-broadcast-demo';

        // connection.mediaConstraints = {
        //     video: {
        //         mandatory: {},
        //         optional: [{
        //             facingMode: 'application' // or "application" for back camera
        //         }]
        //     }
        // };

        connection.session = {
            audio: true,
            video: true,
            oneway: true
        };

        connection.sdpConstraints.mandatory = {
            OfferToReceiveAudio: false,
            OfferToReceiveVideo: false
        };

        // https://www.rtcmulticonnection.org/docs/iceServers/
        // use your own TURN-server here!
        connection.iceServers = [{
            'urls': [
                'stun:stun.l.google.com:19302',
                'stun:stun1.l.google.com:19302',
                'stun:stun2.l.google.com:19302',
                'stun:stun.l.google.com:19302?transport=udp',
            ]
        }];

        connection.videosContainer = document.getElementById('videos-container');
        connection.onstream = function (event) {
            var existing = document.getElementById(event.streamid);
            if (existing && existing.parentNode) {
                existing.parentNode.removeChild(existing);
            }

            event.mediaElement.removeAttribute('src');
            event.mediaElement.removeAttribute('srcObject');
            event.mediaElement.muted = true;
            event.mediaElement.volume = 0;

            var video = document.createElement('video');

            try {
                video.setAttributeNode(document.createAttribute('autoplay'));
                video.setAttributeNode(document.createAttribute('playsinline'));
            } catch (e) {
                video.setAttribute('autoplay', true);
                video.setAttribute('playsinline', true);
            }

            if (event.type === 'local') {
                video.volume = 0;
                try {
                    video.setAttributeNode(document.createAttribute('muted'));
                } catch (e) {
                    video.setAttribute('muted', true);
                }
            }

            video.srcObject = event.stream;

            var width = parseInt(connection.videosContainer.clientWidth / 3) - 20;
            var mediaElement = getHTMLMediaElement(video, {
                title: event.userid,
                buttons: ['full-screen'],
                width: width,
                showOnMouseEnter: false
            });

            connection.videosContainer.appendChild(mediaElement);

            setTimeout(function () {
                mediaElement.media.play();
            }, 5000);

            mediaElement.id = event.streamid;
        };

        connection.onstreamended = function (event) {
            var mediaElement = document.getElementById(event.streamid);
            if (mediaElement) {
                mediaElement.parentNode.removeChild(mediaElement);

                if (event.userid === connection.sessionid && !connection.isInitiator) {
                    alert('Broadcast is ended. We will reload this page to clear the cache.');
                    location.reload();
                }
            }
        };

        connection.onMediaError = function (e) {
            if (e.message === 'Concurrent mic process limit.') {
                if (DetectRTC.audioInputDevices.length <= 1) {
                    alert('Please select external microphone. Check github issue number 483.');
                    return;
                }

                var secondaryMic = DetectRTC.audioInputDevices[1].deviceId;
                connection.mediaConstraints.audio = {
                    deviceId: secondaryMic
                };

                connection.join(connection.sessionid);
            }
        };


        connection.DetectRTC.load(function () {
            // you can access all cameras using "DetectRTC.videoInputDevices"
            connection.DetectRTC.videoInputDevices.forEach(function (device) {
                var option = document.createElement('option');

                // this is what people see
                option.innerHTML = device.label;

                // but this is what inernally used to select relevant device
                option.value = device.id;

                // append to your choice
                document.getElementById('camera-select').appendChild(option);
            });
        });

        // ..................................
        // ALL below scripts are redundant!!!
        // ..................................

        function disableInputButtons() {
            // document.getElementById('room-id').onkeyup();

            document.getElementById('open-or-join-room').disabled = true;
            document.getElementById('open-room').disabled = true;
            document.getElementById('join-room').disabled = true;
            document.getElementById('room-id').disabled = true;
        }

        // ......................................................
        // ......................Handling Room-ID................
        // ......................................................

        function showRoomURL(roomid) {
            var roomHashURL = '#' + roomid;
            var roomQueryStringURL = '?roomid=' + roomid;

            // var html = '<h2>Unique URL for your room:</h2><br>';
            var html = '';
            html += '<a href="' + roomHashURL + '" target="_blank">' + '观看链接1' + '</a>';
            html += '<br>';
            html += '<a href="' + roomQueryStringURL + '" target="_blank">' + '观看链接2' + '</a>';
            html += '<br>';
            html += '<small>点击或复制链接地址后打开观看</small>';

            var roomURLsDiv = document.getElementById('room-urls');
            roomURLsDiv.innerHTML = html;

            roomURLsDiv.style.display = 'block';
        }

        (function () {
            var params = {},
                r = /([^&=]+)=?([^&]*)/g;

            function d(s) {
                return decodeURIComponent(s.replace(/\+/g, ' '));
            }
            var match, search = window.location.search;
            while (match = r.exec(search.substring(1)))
                params[d(match[1])] = d(match[2]);
            window.params = params;
        })();

        // var roomid = '';
        // if (localStorage.getItem(connection.socketMessageEvent)) {
        //     roomid = localStorage.getItem(connection.socketMessageEvent);
        // } else {
        //     roomid = connection.token();
        // }

        roomId = connection.token();
        // document.getElementById('room-id').value = roomid;
        // document.getElementById('room-id').onkeyup = function () {
        //     localStorage.setItem(connection.socketMessageEvent, document.getElementById('room-id').value);
        // };

        var hashString = location.hash.replace('#', '');
        if (hashString.length && hashString.indexOf('comment-') == 0) {
            hashString = '';
        }

        var roomid = params.roomid;
        if (!roomid && hashString.length) {
            roomid = hashString;
        }

        if (roomid && roomid.length) {
            document.getElementById('room-id').value = roomid;
            localStorage.setItem(connection.socketMessageEvent, roomid);

            // auto-join-room
            (function reCheckRoomPresence() {
                connection.checkPresence(roomid, function (isRoomExist) {
                    if (isRoomExist) {
                        connection.join(roomid);
                        return;
                    }

                    setTimeout(reCheckRoomPresence, 5000);
                });
            })();

            disableInputButtons();
        }

        // detect 2G
        if (navigator.connection &&
            navigator.connection.type === 'cellular' &&
            navigator.connection.downlinkMax <= 0.115) {
            alert('2G is not supported. Please use a better internet service.');
        }
    </script>

    <footer>
        <small id="send-message"></small>
    </footer>

    <script src="/demos/js/common.js"></script>
</body>

</html>